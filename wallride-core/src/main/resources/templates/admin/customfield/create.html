<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="utf-8" th:replace="layout::head(${WEBSITE_TITLE})" />
	<title>WallRide</title>
</head>
<body>
<header th:replace="layout::header"></header>
<div>
	<div id="wr-page-header">
		<div class="page-header container-fluid">
			<h1 th:text="#{AddNewCustomField}">ユーザー編集</h1>
		</div>
	</div>
	<div id="wr-page-content">
		<div class="container-fluid">
			<form id="custom-field-form" class="form-horizontal" method="post" th:object="${form}" th:action="@{__${ADMIN_PATH}__/customfields/create}">
				<div class="form-group" th:classappend="${#fields.hasErrors('name')}? has-error">
					<label class="col-sm-2 control-label" th:text="#{FieldName}">FieldName</label>
					<div class="col-sm-10">
						<input type="text" th:field="*{name}" class="form-control" th:attr="placeholder=#{FieldName}" />
						<span class="help-block" th:each="err : ${#fields.errors('name')}" text="${err}" />
					</div>
				</div>
				<div class="form-group" th:classappend="${#fields.hasErrors('description')}? has-error">
					<label class="col-sm-2 control-label" th:text="#{Description}">Description</label>
					<div class="col-sm-10">
						<textarea type="text" th:field="*{description}" class="form-control" style="min-height: 150px" th:attr="placeholder=#{Description}"></textarea>
						<span class="help-block" th:each="err : ${#fields.errors('description')}" text="${err}" />
					</div>
				</div>
				<div class="form-group" th:classappend="${#fields.hasErrors('type')}? has-error">
					<label class="col-sm-2 control-label" th:text="#{FieldType}">FieldType</label>
					<div class="col-sm-6">
						<select class="form-control" th:field="*{type}">
							<option th:each="fieldType : ${fieldTypes}" th:value="${fieldType}" th:text="${#messages.msg('CustomField.FieldType.' + fieldType)}">指定なし</option>
						</select>
						<span class="help-block" th:each="err : ${#fields.errors('type')}" text="${err}" />
					</div>
				</div>
				<div id="custom-field-options" class="form-group field-option-group">
					<label class="col-sm-2 control-label" th:text="#{FieldOption}">FieldOption</label>
					<div class="col-sm-6">
						<input type="text" id="custom-field-options-input" class="form-control input-sm"/>
					</div>
					<div class="col-sm-1">
						<a href="#" class="btn btn-default" data-append="option"><span class="glyphicon glyphicon-plus"></span> 追加</a>
					</div>
					<div class="col-sm-offset-2 col-sm-10">
						<ul class="sortable">
							<script id="option-tmpl" type="text/x-jsrender">
							<li class="option col-sm-7">
								<span class="grippy"></span>
								<div class="field-option"></div>
								<button class="pull-right btn btn-link remove" data-dismiss="option"><span class="glyphicon glyphicon-remove"></span></button>
							</li>
							</script>
						</ul>
<!--
						<input type="hidden" id="options" name="options"/>
-->
					</div>
					<script>
						$(function() {
							var $customFieldForm = $('#custom-field-form');
							var $fieldOption = $('#custom-field-options');

							$customFieldForm.on('change', 'select[name="type"]', function() {
								var value = $(this).val();
								if (value == 'SELECTBOX' || value == 'CHECKBOX' || value == 'RADIO') {
									$fieldOption.show();
								} else {
									$fieldOption.hide();
								}
							});
							$('select[name="type"]',$customFieldForm).trigger('change');

							var $options = [];
							$fieldOption.on('click', '[data-append="option"]', function() {
								var $customInput = $('#custom-field-options-input');
								var customInputOption = $customInput.val();

								if (!isDuplicated($('.field-option'), customInputOption)) {
									$options.push(customInputOption);
									var tmpl = $.templates("#option-tmpl");
									var $content = $(tmpl.render());
									$('.field-option', $content).attr('data-name', customInputOption).text(customInputOption);
									$('.sortable').append($content);
									$customInput.val('').closest('.form-group').removeClass('has-error');
								} else {
									$customInput.closest('.form-group').addClass('has-error');
									return false;
								}
								return false;
							});

							var isDuplicated = function ($optionClass, target) {
								var duplicate = false;
								$.each($optionClass, function() {
									var option = $(this).data('name');
									if (option == target) {
										duplicate = true;
									}
								});
								return duplicate;
							};

							$('.field-option-group').on('click', '[data-dismiss="option"]', function() {
								$(this).closest('.option').remove();
								return false;
							});

							$customFieldForm.on('submit', function(event) {
/*
								var $form = $(event.target);
								$('.btn-save', $form).button('loading');

								$('.form-group', $form).removeClass('has-error');
								$('.form-group', $form).find('.help-block.has-error').remove();
*/

								$('.field-option').each(function(index) {
									var option = $(this).data('name');
									var postName = "options[" + index + "]";
									var field = $('<input type="hidden" />').attr("name", postName).val(option);
									$customFieldForm.append(field);
									index++;
								});

								var replace = function(elements, index) {
									$(elements).each(function(i, element) {
										var name = $(element).attr("data-name");
										if (name) {
											var result = name.match(/\[.+?\]/g);
											name = name.replace(result[0], "[" + index + "]");
											$(element).attr("data-name", name);
										}
									});
									index++;
								};
								console.log($customFieldForm);
								$.post($customFieldForm.attr('action'), $customFieldForm.serialize())
									.done(function(data) {
										window.location.href = $customFieldForm.data('redirect');
									})
									.fail(function(jqXHR) {
										$.each(jqXHR.responseJSON.fieldErrors, function(field, message) {
											var $field = $(':input[name="' + field + '"]', $customFieldForm);
											$field.closest('.form-group').addClass('has-error');
											$field.closest('.form-group').append($('<span class="help-block has-error" />').text(message));
										});
										$('.btn-save', $customFieldForm).button('reset');
									});
/*
								$.post($form.attr('action'), $form.serialize())
										.done(function(data) {
											window.location.href = $form.data('redirect');
										})
										.fail(function(jqXHR) {
											$.each(jqXHR.responseJSON.fieldErrors, function(field, message) {
												var $field = $(':input[name="' + field + '"]', $form);
												$field.closest('.form-group').addClass('has-error');
												$field.closest('.form-group').append($('<span class="help-block has-error" />').text(message));
											});
											$('.btn-save', $form).button('reset');
										});
								return false;
*/
							});
						});
					</script>	
				</div>	
				<div class="form-group">
					<div class="col-sm-offset-2 col-sm-10">
						<div class="btn-group">
							<button name="submit" class="btn btn-primary ok" th:text="#{Save}">Save</button>
						</div>
					</div>
				</div>
			</form>
		</div>
	</div>
</div>
<footer>
</footer>
</body>
</html>